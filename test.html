<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPS 서비스 테스트</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .action-button:hover {
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .speaker-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .speaker-icon {
            font-size: 2rem;
            color: #ccc;
            transition: all 0.3s ease;
        }

        .speaker-container.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .speaker-container.active .speaker-icon {
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .audio-controls {
            margin-top: 1rem;
            text-align: center;
        }

        .audio-controls audio {
            width: 100%;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 MPS 테스트</h1>
            <p>음원 재생 및 가사 다운로드 테스트</p>
        </div>

        <div class="form-group">
            <label for="endpoint">API 엔드포인트</label>
            <input 
                type="text" 
                id="endpoint" 
                placeholder="예: api/music/1/play 또는 api/lyric/1/download"
                value="api/music/1/play"
            >
        </div>

        <div class="form-group">
            <label for="apiKey">API Key</label>
            <input 
                type="text" 
                id="apiKey" 
                placeholder="여기에 API 키를 입력하세요"
                value="test-api-key-12345"
            >
        </div>

        <div class="action-section">
            <button class="action-button" id="actionButton">
                <span id="buttonText">재생</span>
                <span class="loading hidden" id="loadingSpinner"></span>
            </button>
            <div class="speaker-container" id="speakerContainer">
                <div class="speaker-icon">🔊</div>
            </div>
        </div>

        <div class="status-message hidden" id="statusMessage"></div>
        
        <div class="audio-controls hidden" id="audioControls">
            <audio controls id="audioPlayer">
                <source src="" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>

    <script>
        const endpointInput = document.getElementById('endpoint');
        const apiKeyInput = document.getElementById('apiKey');
        const actionButton = document.getElementById('actionButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const speakerContainer = document.getElementById('speakerContainer');
        const statusMessage = document.getElementById('statusMessage');
        const audioControls = document.getElementById('audioControls');
        const audioPlayer = document.getElementById('audioPlayer');

        // MPS 서비스 베이스 URL (실제 환경에서는 변경 필요)
        const MPS_BASE_URL = 'https://api.mps.com/'; // 실제 MPS 서비스 URL로 변경

        // 더미 데이터 - Web Audio API를 사용해 간단한 톤 생성
        function createDummyAudio() {
            // AudioContext를 사용해 간단한 사인파 생성
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const duration = 5; // 5초
            const sampleRate = audioContext.sampleRate;
            const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
            const data = buffer.getChannelData(0);
            
            // 440Hz (A4 음) 사인파 생성
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3;
            }
            
            return buffer;
        }

        // 더미 오디오 URL (실제 작동하는 짧은 무음 MP3)
        const DUMMY_AUDIO_URL = 'data:audio/mp3;base64,//tQxAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA//+QkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQ//+QkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQ';
        const DUMMY_LYRICS = `[00:00.00] 테스트 음원 가사
[00:10.00] MPS 서비스 테스트를 위한
[00:20.00] 더미 가사 파일입니다
[00:30.00] 실제 가사로 교체해 주세요`;

        // 엔드포인트 변경 감지 및 버튼 텍스트 업데이트
        endpointInput.addEventListener('input', updateButtonText);

        function updateButtonText() {
            const endpoint = endpointInput.value.trim();
            if (endpoint.includes('/music/') && endpoint.includes('/play')) {
                buttonText.textContent = '재생';
            } else if (endpoint.includes('/lyric/') && endpoint.includes('/download')) {
                buttonText.textContent = '가사 다운로드';
            } else {
                buttonText.textContent = '요청';
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function setLoading(loading) {
            if (loading) {
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                actionButton.disabled = true;
            } else {
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                actionButton.disabled = false;
            }
        }

        function activateSpeaker() {
            speakerContainer.classList.add('active');
        }

        function deactivateSpeaker() {
            speakerContainer.classList.remove('active');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Web Audio API로 비프음 생성 및 재생
        function playBeepSound(audioContext, musicId) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 음
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 3);
            
            showStatus(`음원 ${musicId}번 재생 중... (테스트 톤)`, 'info');
            
            oscillator.onended = () => {
                deactivateSpeaker();
                showStatus(`음원 ${musicId}번 재생 완료`, 'success');
            };
        }

        // 시각적 재생 시뮬레이션
        function simulatePlayback(musicId) {
            showStatus(`음원 ${musicId}번 재생 중... (시뮬레이션)`, 'info');
            
            // 3초 후 재생 완료 시뮬레이션
            setTimeout(() => {
                deactivateSpeaker();
                showStatus(`음원 ${musicId}번 재생 완료`, 'success');
            }, 3000);
        }

        async function makeRequest() {
            const endpoint = endpointInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            if (!endpoint || !apiKey) {
                showStatus('엔드포인트와 API 키를 모두 입력해주세요.', 'error');
                return;
            }

            setLoading(true);
            hideStatus();
            deactivateSpeaker();
            audioControls.classList.add('hidden');

            try {
                // 실제 환경에서는 이 부분을 실제 API 호출로 교체
                const fullUrl = MPS_BASE_URL + endpoint;
                console.log(`요청 URL: ${fullUrl}`);
                console.log(`API Key: ${apiKey}`);

                // 더미 API 응답 시뮬레이션
                await new Promise(resolve => setTimeout(resolve, 1500)); // 로딩 시뮬레이션

                // API 키 검증 시뮬레이션
                if (apiKey !== 'test-api-key-12345' && apiKey !== 'valid-api-key') {
                    throw new Error('INVALID_API_KEY');
                }

                if (endpoint.includes('/music/') && endpoint.includes('/play')) {
                    // 음원 재생 처리
                    const musicId = endpoint.match(/\/music\/(\d+)\/play/)?.[1];
                    if (!musicId) {
                        throw new Error('잘못된 음원 엔드포인트 형식입니다.');
                    }

                    showStatus(`음원 ${musicId}번 재생 준비 완료`, 'success');
                    activateSpeaker();
                    
                    // 실제 오디오 대신 Web Audio API로 톤 생성 및 재생
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        
                        // 더미 오디오 파일 설정
                        audioPlayer.src = DUMMY_AUDIO_URL;
                        audioControls.classList.remove('hidden');
                        
                        // 수동으로 재생 시작
                        const playPromise = audioPlayer.play();
                        
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                showStatus(`음원 ${musicId}번 재생 중...`, 'info');
                            }).catch((error) => {
                                console.warn('자동 재생 실패, 수동 재생으로 전환:', error);
                                showStatus(`음원 ${musicId}번 재생 준비됨 (재생 버튼을 클릭하세요)`, 'info');
                            });
                        }
                        
                        // 오디오 재생 이벤트 리스너
                        audioPlayer.addEventListener('play', () => {
                            showStatus(`음원 ${musicId}번 재생 중...`, 'info');
                        }, { once: false });
                        
                        audioPlayer.addEventListener('ended', () => {
                            deactivateSpeaker();
                            showStatus(`음원 ${musicId}번 재생 완료`, 'success');
                        }, { once: false });
                        
                        audioPlayer.addEventListener('error', (e) => {
                            console.error('오디오 재생 오류:', e);
                            deactivateSpeaker();
                            
                            // Web Audio API로 대체 재생
                            playBeepSound(audioContext, musicId);
                        }, { once: false });
                        
                    } catch (audioError) {
                        console.warn('AudioContext 생성 실패:', audioError);
                        // AudioContext 실패시 시각적 시뮬레이션만 실행
                        simulatePlayback(musicId);
                    }

                } else if (endpoint.includes('/lyric/') && endpoint.includes('/download')) {
                    // 가사 다운로드 처리
                    const musicId = endpoint.match(/\/lyric\/(\d+)\/download/)?.[1];
                    if (!musicId) {
                        throw new Error('잘못된 가사 엔드포인트 형식입니다.');
                    }

                    downloadFile(DUMMY_LYRICS, `lyrics_${musicId}.txt`, 'text/plain');
                    showStatus(`음원 ${musicId}번 가사 다운로드 완료`, 'success');
                    
                } else {
                    throw new Error('지원하지 않는 엔드포인트 형식입니다.');
                }

            } catch (error) {
                console.error('요청 실패:', error);
                
                if (error.message === 'INVALID_API_KEY') {
                    showStatus('유효하지 않은 API 키입니다.', 'error');
                } else {
                    showStatus(`요청 실패: ${error.message}`, 'error');
                }
                
                deactivateSpeaker();
            } finally {
                setLoading(false);
            }
        }

        // 실제 API 호출 함수 (현재는 주석 처리, 실제 환경에서 사용)
        /*
        async function makeActualRequest(endpoint, apiKey) {
            const response = await fetch(MPS_BASE_URL + endpoint, {
                method: 'GET',
                headers: {
                    'X-API-Key': apiKey,
                    'Accept': endpoint.includes('/music/') ? 'audio/mpeg' : 'text/plain'
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('INVALID_API_KEY');
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return response;
        }
        */

        // 버튼 클릭 이벤트
        actionButton.addEventListener('click', makeRequest);

        // 엔터 키 처리
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !actionButton.disabled) {
                makeRequest();
            }
        });

        // 초기화
        updateButtonText();
    </script>
</body>
</html>